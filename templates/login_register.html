<!DOCTYPE html>
<html lang="lo">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ເຂົ້າສູ່ລະບົບ / ສມັກສະມາຊິກ | CHAMPA BRAND</title>
  <link rel="stylesheet" href="/brand/style.css" />
  <style>
    .auth-page { min-height: 100vh; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
    .auth-box { width: 100%; max-width: 420px; background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(45, 48, 145, 0.12); overflow: hidden; border: 1px solid var(--line); }
    .auth-header { background: #2d3091; color: #fff; padding: 24px; text-align: center; }
    .auth-header h1 { margin: 0; font-size: 1.5rem; font-weight: 800; }
    .auth-header p { margin: 8px 0 0; opacity: 0.9; font-size: 0.9rem; }
    .auth-tabs { display: flex; border-bottom: 1px solid var(--line); }
    .auth-tab { flex: 1; padding: 14px; text-align: center; font-weight: 600; cursor: pointer; background: #f8f9fa; color: var(--muted); border: none; font-family: inherit; font-size: 15px; }
    .auth-tab.active { background: #fff; color: #2d3091; border-bottom: 2px solid #2d3091; }
    .auth-tab:hover:not(.active) { background: #f0f0f0; }
    .auth-body { padding: 24px; }
    .auth-form { display: none; }
    .auth-form.active { display: block; }
    .auth-form label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: var(--text); }
    .auth-form input { width: 100%; padding: 12px 14px; border: 1px solid var(--line); border-radius: 10px; font-size: 15px; font-family: inherit; margin-bottom: 16px; box-sizing: border-box; }
    .auth-form input:focus { outline: none; border-color: #2d3091; box-shadow: 0 0 0 2px rgba(45, 48, 145, 0.2); }
    .auth-form button[type="submit"] { width: 100%; padding: 14px; background: #2d3091; color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .auth-form button[type="submit"]:hover { background: #3d4199; }
    .auth-form .hint { font-size: 12px; color: var(--muted); margin-top: -8px; margin-bottom: 12px; }
    .auth-back { display: inline-block; margin-top: 20px; color: #2d3091; font-weight: 600; text-decoration: none; }
    .auth-back:hover { text-decoration: underline; }
    .auth-msg { padding: 10px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
    .auth-msg.show { display: block; }
    .auth-msg.error { background: #fee; color: #c00; }
    .auth-msg.success { background: #efe; color: #060; }
  </style>
</head>
<body>
  <div class="auth-page">
    <div class="auth-box">
      <div class="auth-header">
        <h1>CHAMPA BRAND</h1>
        <p id="auth-subtitle">ເຂົ້າສູ່ລະບົບ ຫຼື ສມັກສະມາຊິກ</p>
      </div>
      <div class="auth-tabs" id="auth-tabs">
        <button type="button" class="auth-tab active" data-tab="login">ເຂົ້າສູ່ລະບົບ</button>
        <button type="button" class="auth-tab" data-tab="register" id="auth-tab-register">ສມັກສະມາຊິກ</button>
      </div>
      <div class="auth-body">
        <div id="auth-msg" class="auth-msg"></div>

        <!-- ฟอร์ม Login -->
        <form id="form-login" class="auth-form active" method="post">
          <label for="login-username">Username ຫຼື ເບີມືຖື (020xxxxxxxx)</label>
          <input type="text" id="login-username" name="username" placeholder="username ຫຼື 020xxxxxxxx" required autocomplete="username" />
          <label for="login-password">ລະຫັດຜ່ານ</label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password" />
          <button type="submit">ເຂົ້າສູ່ລະບົບ</button>
        <p id="login-setup-hint" class="hint" style="display: none; margin-top: 12px;">
          ยังไม่มีแอดมิน? <a href="/setup">สร้างแอดมินคนแรก</a>
        </p>
        </form>

        <!-- ฟอร์ม Register -->
        <form id="form-register" class="auth-form" method="post">
          <label for="reg-username">Username</label>
          <input type="text" id="reg-username" name="username" placeholder="ຕັ້ງຊື່ໃຊ້ເຂົ້າລະບົບ" required autocomplete="username" />
          <label for="reg-phone">ເບີມືຖື (ລາວ 020...)</label>
          <input type="tel" id="reg-phone" name="phone" placeholder="020xxxxxxxx" autocomplete="tel" />
          <p class="hint">ບໍ່ບັງຄັບ ຖ້າມີໃສ່ໄວ້ໃຊ້ເຂົ້າລະບົບໄດ້</p>
          <label for="reg-password">ລະຫັດຜ່ານ</label>
          <input type="password" id="reg-password" name="password" required autocomplete="new-password" />
          <button type="submit">ສມັກສະມາຊິກ</button>
        </form>
      </div>
    </div>
    <!-- <div class="auth-links">
      <a href="/brand/" class="auth-back">← ກັບໄປຫນ້າຫຼັກ</a>
      <a href="/dashboard" class="auth-back auth-admin">ເຂົ້າຫນ້າ Admin →</a>
    </div> -->
  </div>

  <script src="/static/js/notification.js"></script>
  <script>
    (function() {
      // หน้า Admin: ไม่แสดง Register (เมื่อ next ไป dashboard/admin/customer/product)
      const params = new URLSearchParams(window.location.search);
      const next = params.get("next") || "";
      const adminPaths = ["/dashboard", "/admin", "/customer", "/product"];
      const isAdminLogin = adminPaths.some(function(p) { return next.startsWith(p); });
      if (isAdminLogin) {
        const tabRegister = document.getElementById("auth-tab-register");
        const formRegister = document.getElementById("form-register");
        const subtitle = document.getElementById("auth-subtitle");
        const setupHint = document.getElementById("login-setup-hint");
        if (tabRegister) tabRegister.style.display = "none";
        if (formRegister) formRegister.style.display = "none";
        if (subtitle) subtitle.textContent = "ເຂົ້າສູ່ລະບົບ Admin";
        if (setupHint) setupHint.style.display = "block";
      }

      const msgEl = document.getElementById("auth-msg");
      function showMsg(text, type) {
        msgEl.textContent = text;
        msgEl.className = "auth-msg show " + (type || "");
      }
      function clearMsg() {
        msgEl.className = "auth-msg";
        msgEl.textContent = "";
      }

      // Tabs
      document.querySelectorAll(".auth-tab").forEach(function(btn) {
        btn.addEventListener("click", function() {
          const tab = this.dataset.tab;
          document.querySelectorAll(".auth-tab").forEach(function(b) { b.classList.remove("active"); });
          document.querySelectorAll(".auth-form").forEach(function(f) { f.classList.remove("active"); });
          this.classList.add("active");
          document.getElementById("form-" + tab).classList.add("active");
          clearMsg();
        });
      });

      // Login
      document.getElementById("form-login").addEventListener("submit", async function(e) {
        e.preventDefault();
        clearMsg();
        const username = document.getElementById("login-username").value.trim();
        const password = document.getElementById("login-password").value;
        if (!username || !password) {
          showMsg("ກະລຸນາໃສ່ username/ເບີ ແລະ ລະຫັດຜ່ານ", "error");
          return;
        }
        try {
          if (typeof Notification !== "undefined") Notification.info("ກຳລັງເຂົ້າສູ່ລະບົບ...", 1000);
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username, password: password })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "ເຂົ້າສູ່ລະບົບບໍ່ສຳເລັດ");
          if (data.token) {
            try {
              var isAdmin = data.user && data.user.role === "admin";
              if (isAdmin) {
                // บันทึก token ลง localStorage ก่อน redirect
                localStorage.setItem("token", data.token);  // ฝั่ง Admin ใช้ key นี้
                // ไม่เขียน champa_token เพื่อให้แท็บ client ยังใช้ลูกค้าคนเดิมได้
              } else {
                localStorage.setItem("champa_token", data.token);  // ฝั่ง Client ใช้ key นี้
                // ไม่เขียน token เพื่อให้แท็บ Admin ยังใช้แอดมินคนเดิมได้
              }
            } catch (e) {
              console.error("Error saving token:", e);
            }
            if (typeof Notification !== "undefined") Notification.success("ເຂົ້າສູ່ລະບົບສຳເລັດ!");
            
            // รอให้ localStorage บันทึกเสร็จก่อน redirect
            setTimeout(function() {
              var next = (new URLSearchParams(window.location.search)).get("next");
              if (next && next.startsWith("/brand")) {
                window.location.href = next;
              } else if (next && isAdmin) {
                window.location.href = next + (next.indexOf("?") >= 0 ? "&" : "?") + "token=" + encodeURIComponent(data.token);
              } else if (next) {
                window.location.href = next;
              } else if (isAdmin) {
                window.location.href = "/dashboard?token=" + encodeURIComponent(data.token);
              } else {
                window.location.href = "/brand/";
              }
            }, 100);
          } else {
            showMsg("ເຂົ້າສູ່ລະບົບສຳເລັດ", "success");
            setTimeout(function() { window.location.href = "/brand/"; }, 800);
          }
        } catch (err) {
          showMsg(err.message || "ເກີດຂໍ້ຜິດພາດ", "error");
          if (typeof Notification !== "undefined") Notification.error(err.message);
        }
      });

      // Register
      document.getElementById("form-register").addEventListener("submit", async function(e) {
        e.preventDefault();
        clearMsg();
        const username = document.getElementById("reg-username").value.trim();
        const phone = document.getElementById("reg-phone").value.trim();
        const password = document.getElementById("reg-password").value;
        if (!username || !password) {
          showMsg("ກະລຸນາໃສ່ username ແລະ ລະຫັດຜ່ານ", "error");
          return;
        }
        try {
          if (typeof Notification !== "undefined") Notification.info("ກຳລັງສມັກສະມາຊິກ...", 1000);
          const res = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username, phone: phone || undefined, password: password })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "ສມັກສະມາຊິກບໍ່ສຳເລັດ");
          showMsg("ສມັກສະມາຊິກສຳເລັດ! ກະລຸນາເຂົ້າສູ່ລະບົບ.", "success");
          if (typeof Notification !== "undefined") Notification.success("ສມັກສະມາຊິກສຳເລັດ!");
          setTimeout(function() {
            document.querySelector(".auth-tab[data-tab=login]").click();
            document.getElementById("login-username").value = username;
          }, 1500);
        } catch (err) {
          showMsg(err.message || "ເກີດຂໍ້ຜິດພາດ", "error");
          if (typeof Notification !== "undefined") Notification.error(err.message);
        }
      });
    })();
  </script>
</body>
</html>
